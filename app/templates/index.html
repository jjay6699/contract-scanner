<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Latest Contract Deployment (Base)</title>
    <style>
      :root { color-scheme: light dark; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 1rem; max-width: 960px; margin-inline: auto; }
      h1 { margin: 0 0 0.25rem 0; line-height: 1.2; }
      .muted { color: #777; font-size: 0.9rem; }
      .grid { display: grid; grid-template-columns: 140px 1fr; gap: 0.35rem 1rem; margin-top: 1rem; align-items: baseline; }
      .label { opacity: 0.8; font-size: 0.9rem; }
      .value { word-break: break-word; }
      .card { border: 1px solid #ccc; border-radius: 8px; padding: 1rem; margin-top: 1rem; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
      .break { word-break: break-word; overflow-wrap: anywhere; }
      .trunc { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 28ch; display: inline-block; vertical-align: bottom; }
      @media (max-width: 560px) {.trunc { max-width: 18ch; }}
      a { text-decoration: none; }
      table { width: 100%; border-collapse: collapse; }
      th, td { padding: 0.25rem; border-bottom: 1px solid #eee; text-align: left; }
      th { border-bottom-color: #ccc; }
      .table-wrap { overflow: auto; }
      @media (max-width: 560px) {
        body { padding: 0.75rem; }
        .grid { grid-template-columns: 1fr; }
        .label { margin-top: 0.5rem; }
        .value strong { display: inline-block; margin-top: -0.1rem; }
      }
    </style>
  </head>
  <body>
    <h1>Latest Contract Deployment</h1>
    <div class="muted">Chain {{ chain_id }} · Deployer <code>{{ deployer }}</code> · Scans every {{ interval_seconds }}s</div>

    <div class="card" id="status">
      {% if latest %}
      <div class="grid">
        <div class="label">Last Scan</div><div class="value"><strong>{{ last_run_utc }}</strong></div>
        <div class="label">Contract</div><div class="value mono break"><a target="_blank" rel="noopener" href="https://basescan.org/address/{{ latest.contract }}">{{ latest.contract }}</a></div>
        <div class="label">Block</div><div class="value">{{ latest.block }}</div>
        <div class="label">Tx</div><div class="value mono break"><a target="_blank" rel="noopener" href="https://basescan.org/tx/{{ latest.tx }}">{{ latest.tx }}</a></div>
        <div class="label">UTC</div><div class="value">{{ latest.utc }}</div>
      </div>
      {% else %}
      <div>No result yet. Last scan: {{ last_run_utc or 'pending...' }}</div>
      {% endif %}
      {% if last_error %}
      <div style="margin-top: 0.5rem; color: #b00020;">Error: {{ last_error }}</div>
      {% endif %}
    </div>

    <div class="card" id="history">
      <h2 style="margin-top:0">Last {{ history_max }} Deployments</h2>
      {% if history and history|length > 0 %}
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>UTC</th>
              <th>Contract</th>
              <th>Block</th>
              <th>Tx</th>
            </tr>
          </thead>
          <tbody>
            {% for item in history %}
            <tr>
              <td style="white-space: nowrap;">{{ item.utc }}</td>
              <td class="mono break"><a target="_blank" rel="noopener" href="https://basescan.org/address/{{ item.contract }}">{{ item.contract }}</a></td>
              <td>{{ item.block }}</td>
              <td class="mono break"><a target="_blank" rel="noopener" href="https://basescan.org/tx/{{ item.tx }}">{{ item.tx }}</a></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div>No history yet.</div>
      {% endif %}
    </div>

    <div class="muted" style="margin-top: 0.75rem;">Total runs: {{ runs }} · Started: {{ started_at }}</div>

    <script>
      function shortHex(s) {
        if (!s) return '';
        if (s.length <= 12) return s;
        return s.slice(0, 6) + '…' + s.slice(-4);
      }

      async function refresh() {
        try {
          const r = await fetch('/api/latest?t=' + Date.now(), {cache: 'no-store'});
          if (!r.ok) return;
          const data = await r.json();
          const status = document.getElementById('status');
          let html = '';
          if (data.latest) {
            html += '<div class="grid">';
            html += '<div class="label">Last Scan</div><div class="value"><strong>' + (data.last_run_utc || '') + '</strong></div>';
            const addr = data.latest.contract;
            const tx = data.latest.tx;
            html += '<div class="label">Contract</div><div class="value mono"><a class="trunc" title="' + addr + '" target="_blank" rel="noopener" href="https://basescan.org/address/' + addr + '">' + shortHex(addr) + '</a></div>';
            html += '<div class="label">Block</div><div class="value">' + (data.latest.block || '') + '</div>';
            html += '<div class="label">Tx</div><div class="value mono"><a class="trunc" title="' + tx + '" target="_blank" rel="noopener" href="https://basescan.org/tx/' + tx + '">' + shortHex(tx) + '</a></div>';
            html += '<div class="label">UTC</div><div class="value">' + (data.latest.utc || '') + '</div>';
            html += '</div>';
          } else {
            html += '<div>No result yet. Last scan: ' + (data.last_run_utc || 'pending...') + '</div>';
          }
          if (data.last_error) {
            html += '<div style="margin-top: 0.5rem; color: #b00020;">Error: ' + data.last_error + '</div>';
          }
          status.innerHTML = html;

          // Render history table
          const historyEl = document.getElementById('history');
          let h = '<h2 style="margin-top:0">Last ' + ({{ history_max }} || 50) + ' Deployments</h2>';
          const history = data.history || [];
          if (history.length > 0) {
            h += '<div class="table-wrap">';
            h += '<table>';
            h += '<thead><tr>';
            h += '<th>UTC</th>';
            h += '<th>Contract</th>';
            h += '<th>Block</th>';
            h += '<th>Tx</th>';
            h += '</tr></thead><tbody>';
            for (const item of history) {
              const c = item.contract;
              const t = item.tx;
              h += '<tr>';
              h += '<td style="white-space: nowrap;">' + (item.utc || '') + '</td>';
              h += '<td class="mono"><a class="trunc" title="' + c + '" target="_blank" rel="noopener" href="https://basescan.org/address/' + c + '">' + shortHex(c) + '</a></td>';
              h += '<td>' + (item.block || '') + '</td>';
              h += '<td class="mono"><a class="trunc" title="' + t + '" target="_blank" rel="noopener" href="https://basescan.org/tx/' + t + '">' + shortHex(t) + '</a></td>';
              h += '</tr>';
            }
            h += '</tbody></table></div>';
          } else {
            h += '<div>No history yet.</div>';
          }
          historyEl.innerHTML = h;

          // Update footer with latest runs/started
          const footers = document.querySelectorAll('div.muted');
          if (footers && footers.length) {
            const runs = Number(data.runs || 0);
            const started = data.started_at || '';
            footers[footers.length - 1].textContent = 'Total runs: ' + runs + ' · Started: ' + started;
          }
        } catch (e) {
          // ignore transient errors
        }
      }
      refresh();
      setInterval(refresh, 10000);
    </script>
  </body>
  </html>
